package com.ppsea.ds.data.model;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import javax.script.Bindings;
import javax.script.CompiledScript;
import javax.script.ScriptException;

import org.apache.log4j.Logger;

import com.ppsea.ds.data.BaseObject;
import com.ppsea.ds.data.DialogAction;
import com.ppsea.ds.data.Scriptable;
import com.ppsea.ds.manager.MissionMG;
import com.ppsea.ds.util.Util;

public class Npc extends BaseObject implements Scriptable,Cloneable{
    /**
     * This field was generated by Apache iBATIS ibator.
     * This field corresponds to the database column npc.id
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    private Integer id;

    /**
     * This field was generated by Apache iBATIS ibator.
     * This field corresponds to the database column npc.name
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    private String name;

    /**
     * This field was generated by Apache iBATIS ibator.
     * This field corresponds to the database column npc.description
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    private String description;

    /**
     * This field was generated by Apache iBATIS ibator.
     * This field corresponds to the database column npc.type
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    private Integer type;

    /**
     * This field was generated by Apache iBATIS ibator.
     * This field corresponds to the database column npc.random_showup
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    private Boolean randomShowup;

    /**
     * This field was generated by Apache iBATIS ibator.
     * This field corresponds to the database column npc.show_for_mission
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    private Boolean showForMission;

    /**
     * This field was generated by Apache iBATIS ibator.
     * This field corresponds to the database column npc.dialog_input
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    private String dialogInput;

    /**
     * This field was generated by Apache iBATIS ibator.
     * This field corresponds to the database column npc.command
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    private String command;

    /**
     * This field was generated by Apache iBATIS ibator.
     * This field corresponds to the database column npc.name_pinyin
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    private String namePinyin;

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method returns the value of the database column npc.id
     *
     * @return the value of npc.id
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public Integer getId() {
        return id;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method sets the value of the database column npc.id
     *
     * @param id the value for npc.id
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public void setId(Integer id) {
        this.id = id;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method returns the value of the database column npc.name
     *
     * @return the value of npc.name
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public String getName() {
        return name;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method sets the value of the database column npc.name
     *
     * @param name the value for npc.name
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public void setName(String name) {
        this.name = name;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method returns the value of the database column npc.description
     *
     * @return the value of npc.description
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public String getDescription() {
        return description;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method sets the value of the database column npc.description
     *
     * @param description the value for npc.description
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public void setDescription(String description) {
        this.description = description;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method returns the value of the database column npc.type
     *
     * @return the value of npc.type
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public Integer getType() {
        return type;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method sets the value of the database column npc.type
     *
     * @param type the value for npc.type
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public void setType(Integer type) {
        this.type = type;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method returns the value of the database column npc.random_showup
     *
     * @return the value of npc.random_showup
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public Boolean getRandomShowup() {
        return randomShowup;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method sets the value of the database column npc.random_showup
     *
     * @param randomShowup the value for npc.random_showup
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public void setRandomShowup(Boolean randomShowup) {
        this.randomShowup = randomShowup;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method returns the value of the database column npc.show_for_mission
     *
     * @return the value of npc.show_for_mission
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public Boolean getShowForMission() {
        return showForMission;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method sets the value of the database column npc.show_for_mission
     *
     * @param showForMission the value for npc.show_for_mission
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public void setShowForMission(Boolean showForMission) {
        this.showForMission = showForMission;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method returns the value of the database column npc.dialog_input
     *
     * @return the value of npc.dialog_input
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public String getDialogInput() {
        return dialogInput;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method sets the value of the database column npc.dialog_input
     *
     * @param dialogInput the value for npc.dialog_input
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public void setDialogInput(String dialogInput) {
        this.dialogInput = dialogInput;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method returns the value of the database column npc.command
     *
     * @return the value of npc.command
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public String getCommand() {
        return command;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method sets the value of the database column npc.command
     *
     * @param command the value for npc.command
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public void setCommand(String command) {
        this.command = command;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method returns the value of the database column npc.name_pinyin
     *
     * @return the value of npc.name_pinyin
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public String getNamePinyin() {
        return namePinyin;
    }

    /**
     * This method was generated by Apache iBATIS ibator.
     * This method sets the value of the database column npc.name_pinyin
     *
     * @param namePinyin the value for npc.name_pinyin
     *
     * @ibatorgenerated Tue Apr 06 13:45:19 CST 2010
     */
    public void setNamePinyin(String namePinyin) {
        this.namePinyin = namePinyin;
    }
    
    private static final Logger log = Logger.getLogger(Npc.class);
    
    public static final int NPC_NORMAL = 0;
	
	// Mission list
	private transient Map<String, Mission> missions = new LinkedHashMap<String, Mission>();
	
	// Start mission list
	private transient List<Mission> startMissions = new ArrayList<Mission>();
	
	// UUID: from facilityNpc ID
	private int uuid = 0;
	
	private Facility facility = null;
	
	// Compile the script for better performance (increase at least 20%)
	private transient CompiledScript script = null;
	
	// NPC questions
	private transient List<Question> questions = new ArrayList<Question>();
	private transient Map<Integer, Integer> questionIds = new HashMap<Integer, Integer>();
    
	/**
	 * Compile the script
	 *     
	 * @return void    
	 * @throws
	 */
	public void compile(){
		try {
			if(script == null)
				script = Util.getCompilabe().compile(dialogInput + SCRIPT_FUNCTIONS);
		} catch (ScriptException e) {
			log.error("exception",e);
		}
	}
	
	/**
	 * Execute script and get the npc's dialog and actions
	 * 
	 * @param  @param player
	 * @param  @param npc
	 * @param  @return    
	 * @return NpcDialogAction    
	 * @throws
	 */
	public DialogAction execute(Player player, String action) {
		Bindings bindings = Util.getScriptEngine().createBindings();
		bindings.put(VARIABLE_PLAYER, player);
		bindings.put(VARIABLE_NPC, this);
		bindings.put(VARIABLE_DIALOG, DEFAULT_DIALOG);
		if(action != null) bindings.put(PARAM_ACTION, action);
		bindings.put(VARIABLE_ACTION_IDS, new ArrayList<Double>());
		bindings.put(VARIABLE_REDIRECT, "");
		bindings.put(VARIABLE_QUESTION_ID, new Integer(0));
		bindings.put(VARIABLE_UPGRADE, false);
		
		try {
//			if(Constants.DEBUG) Util.getScriptEngine().eval(DBManager.getDialogInput(this.id) + SCRIPT_FUNCTIONS, bindings);
			script.eval(bindings);
			
			String dialog = (String)bindings.get(VARIABLE_DIALOG);
			
			List<Double> actionIds = (List<Double>)bindings.get(VARIABLE_ACTION_IDS);
			List<Action> actions = new ArrayList<Action>(2);
			
			for(Double actionId : actionIds){
				actions.add(MissionMG.instance.getAction(actionId.intValue()));
			}

			Question question = null;
			
			int qid = ((Integer)bindings.get(VARIABLE_QUESTION_ID)).intValue();
			if(qid > 0) question = MissionMG.instance.getQuestion(qid);
			
			return new DialogAction(dialog, actions, (String)bindings.get(VARIABLE_REDIRECT), question, (Boolean)bindings.get(VARIABLE_UPGRADE));
			
		} catch (ScriptException e) {
			log.error("exception",e);
		}
		
		return null;
	}
	
	public DialogAction execute(Player player){
		return execute(player, null);
	}
	
	public Map<String, Mission> getMissions() {
		return missions;
	}

	public void setMissions(Map<String, Mission> missions) {
		this.missions = missions;
	}
	
	public Mission getMission(String key){
		return this.missions.get(key);
	}
	
	public Object clone(){
		try {
			return super.clone();
		} catch (CloneNotSupportedException e) {
			e.printStackTrace();
			
			return new Npc();
		}
	}

	public int getUuid() {
		return uuid;
	}

	public void setUuid(int uuid) {
		this.uuid = uuid;
	}

	public Facility getFacility() {
		return facility;
	}

	public void setFacility(Facility facility) {
		this.facility = facility;
	}

	public List<Mission> getStartMissions() {
		return startMissions;
	}

	public void setStartMissions(List<Mission> startMissions) {
		this.startMissions = startMissions;
	}

}