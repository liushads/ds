package com.ppsea.ds.data.model;

import java.util.ArrayList;
import java.util.List;

import javax.script.Bindings;
import javax.script.CompiledScript;
import javax.script.ScriptException;

import org.apache.log4j.Logger;

import com.ppsea.ds.data.BaseObject;
import com.ppsea.ds.data.DialogAction;
import com.ppsea.ds.data.Scriptable;
import com.ppsea.ds.manager.MissionMG;
import com.ppsea.ds.service.DBService;
import com.ppsea.ds.util.Util;

/**
 * ClassName:Mission
 *
 * @author   Daniel.Hao
 * @version  
 * @since    Ver 1.0
 * @Date	 2008	Dec 10, 2008		10:22:09 PM
 *
 * @see 	 
 */
public class Mission extends BaseObject implements Scriptable{
	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.id
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer id;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.name
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private String name;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.type
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer type;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.condition_cancel
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private String conditionCancel;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.repeat_times
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer repeatTimes;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.total_offer
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer totalOffer;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.total_ongoing
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer totalOngoing;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.total_cancel
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer totalCancel;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.description
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private String description;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.pre_mission_state
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer preMissionState;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.mission_start
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private String missionStart;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.cityfacility_id
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer cityfacilityId;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.condition_level
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer conditionLevel;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.condition_fame
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer conditionFame;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.bonus
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private String bonus;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.extra_bonus
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private String extraBonus;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.objective
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private String objective;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.monster_level
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private String monsterLevel;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.is_validate
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Boolean isValidate;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.name_pinyin
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private String namePinyin;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.condition_time_limit
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer conditionTimeLimit;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.condition_team_size
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer conditionTeamSize;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.stage
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer stage;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.condition_time_range
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer conditionTimeRange;

	/**
	 * This field was generated by Abator for iBATIS. This field corresponds to the database column mission.condition_level_end
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	private Integer conditionLevelEnd;

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.id
	 * @return  the value of mission.id
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getId() {
		return id;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.id
	 * @param id  the value for mission.id
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setId(Integer id) {
		this.id = id;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.name
	 * @return  the value of mission.name
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public String getName() {
		return name;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.name
	 * @param name  the value for mission.name
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setName(String name) {
		this.name = name;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.type
	 * @return  the value of mission.type
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getType() {
		return type;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.type
	 * @param type  the value for mission.type
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setType(Integer type) {
		this.type = type;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.condition_cancel
	 * @return  the value of mission.condition_cancel
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public String getConditionCancel() {
		return conditionCancel;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.condition_cancel
	 * @param conditionCancel  the value for mission.condition_cancel
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setConditionCancel(String conditionCancel) {
		this.conditionCancel = conditionCancel;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.repeat_times
	 * @return  the value of mission.repeat_times
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getRepeatTimes() {
		return repeatTimes;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.repeat_times
	 * @param repeatTimes  the value for mission.repeat_times
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setRepeatTimes(Integer repeatTimes) {
		this.repeatTimes = repeatTimes;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.total_offer
	 * @return  the value of mission.total_offer
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getTotalOffer() {
		return totalOffer;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.total_offer
	 * @param totalOffer  the value for mission.total_offer
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setTotalOffer(Integer totalOffer) {
		this.totalOffer = totalOffer;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.total_ongoing
	 * @return  the value of mission.total_ongoing
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getTotalOngoing() {
		return totalOngoing;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.total_ongoing
	 * @param totalOngoing  the value for mission.total_ongoing
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setTotalOngoing(Integer totalOngoing) {
		this.totalOngoing = totalOngoing;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.total_cancel
	 * @return  the value of mission.total_cancel
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getTotalCancel() {
		return totalCancel;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.total_cancel
	 * @param totalCancel  the value for mission.total_cancel
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setTotalCancel(Integer totalCancel) {
		this.totalCancel = totalCancel;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.description
	 * @return  the value of mission.description
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public String getDescription() {
		return description;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.description
	 * @param description  the value for mission.description
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setDescription(String description) {
		this.description = description;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.pre_mission_state
	 * @return  the value of mission.pre_mission_state
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getPreMissionState() {
		return preMissionState;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.pre_mission_state
	 * @param preMissionState  the value for mission.pre_mission_state
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setPreMissionState(Integer preMissionState) {
		this.preMissionState = preMissionState;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.mission_start
	 * @return  the value of mission.mission_start
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public String getMissionStart() {
		return missionStart;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.mission_start
	 * @param missionStart  the value for mission.mission_start
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setMissionStart(String missionStart) {
		this.missionStart = missionStart;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.cityfacility_id
	 * @return  the value of mission.cityfacility_id
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getCityfacilityId() {
		return cityfacilityId;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.cityfacility_id
	 * @param cityfacilityId  the value for mission.cityfacility_id
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setCityfacilityId(Integer cityfacilityId) {
		this.cityfacilityId = cityfacilityId;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.condition_level
	 * @return  the value of mission.condition_level
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getConditionLevel() {
		return conditionLevel;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.condition_level
	 * @param conditionLevel  the value for mission.condition_level
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setConditionLevel(Integer conditionLevel) {
		this.conditionLevel = conditionLevel;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.condition_fame
	 * @return  the value of mission.condition_fame
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getConditionFame() {
		return conditionFame;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.condition_fame
	 * @param conditionFame  the value for mission.condition_fame
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setConditionFame(Integer conditionFame) {
		this.conditionFame = conditionFame;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.bonus
	 * @return  the value of mission.bonus
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public String getBonus() {
		return bonus;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.bonus
	 * @param bonus  the value for mission.bonus
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setBonus(String bonus) {
		this.bonus = bonus;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.extra_bonus
	 * @return  the value of mission.extra_bonus
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public String getExtraBonus() {
		return extraBonus;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.extra_bonus
	 * @param extraBonus  the value for mission.extra_bonus
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setExtraBonus(String extraBonus) {
		this.extraBonus = extraBonus;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.objective
	 * @return  the value of mission.objective
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public String getObjective() {
		return objective;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.objective
	 * @param objective  the value for mission.objective
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setObjective(String objective) {
		this.objective = objective;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.monster_level
	 * @return  the value of mission.monster_level
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public String getMonsterLevel() {
		return monsterLevel;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.monster_level
	 * @param monsterLevel  the value for mission.monster_level
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setMonsterLevel(String monsterLevel) {
		this.monsterLevel = monsterLevel;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.is_validate
	 * @return  the value of mission.is_validate
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Boolean getIsValidate() {
		return isValidate;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.is_validate
	 * @param isValidate  the value for mission.is_validate
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setIsValidate(Boolean isValidate) {
		this.isValidate = isValidate;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.name_pinyin
	 * @return  the value of mission.name_pinyin
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public String getNamePinyin() {
		return namePinyin;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.name_pinyin
	 * @param namePinyin  the value for mission.name_pinyin
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setNamePinyin(String namePinyin) {
		this.namePinyin = namePinyin;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.condition_time_limit
	 * @return  the value of mission.condition_time_limit
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getConditionTimeLimit() {
		return conditionTimeLimit;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.condition_time_limit
	 * @param conditionTimeLimit  the value for mission.condition_time_limit
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setConditionTimeLimit(Integer conditionTimeLimit) {
		this.conditionTimeLimit = conditionTimeLimit;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.condition_team_size
	 * @return  the value of mission.condition_team_size
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getConditionTeamSize() {
		return conditionTeamSize;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.condition_team_size
	 * @param conditionTeamSize  the value for mission.condition_team_size
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setConditionTeamSize(Integer conditionTeamSize) {
		this.conditionTeamSize = conditionTeamSize;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.stage
	 * @return  the value of mission.stage
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getStage() {
		return stage;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.stage
	 * @param stage  the value for mission.stage
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setStage(Integer stage) {
		this.stage = stage;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.condition_time_range
	 * @return  the value of mission.condition_time_range
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getConditionTimeRange() {
		return conditionTimeRange;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.condition_time_range
	 * @param conditionTimeRange  the value for mission.condition_time_range
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setConditionTimeRange(Integer conditionTimeRange) {
		this.conditionTimeRange = conditionTimeRange;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method returns the value of the database column mission.condition_level_end
	 * @return  the value of mission.condition_level_end
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public Integer getConditionLevelEnd() {
		return conditionLevelEnd;
	}

	/**
	 * This method was generated by Abator for iBATIS. This method sets the value of the database column mission.condition_level_end
	 * @param conditionLevelEnd  the value for mission.condition_level_end
	 * @abatorgenerated  Sat Sep 19 15:32:15 CST 2009
	 */
	public void setConditionLevelEnd(Integer conditionLevelEnd) {
		this.conditionLevelEnd = conditionLevelEnd;
	}

	private static final Logger log = Logger.getLogger(Mission.class);
	
	private static final long serialVersionUID = 1L;
	
	public static final int MISSION_NORMAL = 0;
	public static final int MISSION_REGION = 1;
	public static final int MISSION_ACTIVITY = 2;
	public static final int MISSION_KEY = 3;
	
	private static final String MISSION_FLAG = "flag";
	private static final String MISSION_CHECK = "check";
	private static final String MISSION_CONDITION = "condition";
	
	public static final int STATE_NO_CHECK = 0;
	public static final int STATE_NOT_COMPLETE = 1;
	public static final int STATE_COMPLETE = 2;
	
	// Previous mission list
	private transient List<Mission> preMissions = null;
	
	// Timer in milliseconds
	private long timer = 0;

	// Compile the script for better performance (increase at least 20%)
	protected transient CompiledScript scriptStart = null;
	protected transient CompiledScript scriptOngoing = null;
	protected transient CompiledScript scriptEnd = null;
	protected transient CompiledScript scriptCancel = null;
	
	public void compile(){
		
	}
	
	/**
	 * Test if there are available missions for the player
	 * 
	 * @param  @param player
	 * @param  @return    
	 * @return boolean    
	 * @throws
	 */
	public boolean canStartMission (Player player, Npc npc, MissionCondition condition){
//		return check(player, this.conditionStart);
		return check(player, npc, null, scriptStart, false, condition);
	}
	
	/**
	 * Test if can end the mission with success
	 * 
	 * @param  @param player
	 * @param  @return    
	 * @return boolean    
	 * @throws
	 */
	public boolean canEndMission(Player player, Npc npc, PlayerMission mission){
//		return check(player, this.conditionEnd);
		return check(player, npc, mission, scriptEnd);
	}
	
	/**
	 * Check if need to go into ongoing script
	 * 
	 * @param player
	 * @param npc
	 * @param mission
	 * @return    
	 * @return boolean    
	 * @throws
	 */
	public boolean isOngoingMission(Player player, Npc npc, PlayerMission mission){
//		return check(player, this.conditionOngoing);
		return check(player, npc, mission, scriptOngoing, true, null);
	}
	
	/**
	 * Get the mission data (dialog, actions) based on the input conditions
	 * 
	 * @param  @param player
	 * @param  @return    
	 * @return NpcDialogAction    
	 * @throws
	 */
	public DialogAction getMission(Player player, Npc npc, MissionCondition condition){
//		return execute(player, this.conditionStart);
		return execute(player, npc, null, scriptStart, condition);
	}
	
	/**
	 * Get the mission end data, include dialog, actions, bonus
	 * 
	 * @param  @param player
	 * @param  @return    
	 * @return NpcDialogAction    
	 * @throws
	 */
	public DialogAction endMission(Player player, Npc npc, PlayerMission mission, MissionCondition condition){
//		return execute(player, this.conditionEnd);
		return execute(player, npc, mission, scriptEnd, condition);
	}
	
	/**
	 * Get ongoing dialog and actions
	 * 
	 * @param player
	 * @return    
	 * @return NpcDialogAction    
	 * @throws
	 */
	public DialogAction ongoingMission(Player player, Npc npc, PlayerMission mission, MissionCondition condition){
//		return execute(player, this.conditionOngoing);
		return execute(player, npc, mission, scriptOngoing, condition);
	}
	
	/**
	 * When start the mission, execute the start script
	 * 
	 * @param player
	 * @param npc
	 * @param mission    
	 * @return void    
	 * @throws
	 */
//	public void startMission(Player player, Npc npc, PlayerMission mission){
////		execute(player, this.missionStart);
//		String script = DbManager.getMissionStartScript(id);
//		
//		if(script != null)
//			execute(player, npc, mission, script, null);
//	}

	public DialogAction cancelMission(Player player, PlayerMission mission){
		return execute(player, null, mission, scriptCancel, null);
	}

	/**
	 * Check condition based on the script
	 * 
	 * @param  @param player
	 * @param  @param script
	 * @param  @return    
	 * @return boolean    
	 * @throws
	 */
	private boolean check(Player player, Npc npc, PlayerMission mission, CompiledScript script, boolean flag, MissionCondition condition){
		Bindings bindings = Util.getScriptEngine().createBindings();
		bindings.put(VARIABLE_PLAYER, player);
		bindings.put(VARIABLE_NPC, npc);
		if(mission != null)bindings.put(VARIABLE_MISSION, mission);
		if(condition != null)bindings.put(MISSION_CONDITION, condition);
		bindings.put(MISSION_FLAG, flag);
		bindings.put(MISSION_CHECK, true);
		bindings.put(VARIABLE_DIALOG, DEFAULT_DIALOG);
		
		try {
//			if(Constants.DEBUG){
//				if(script == scriptStart)
//					Util.getScriptEngine().eval(DBManager.getMissionStart(this.id) + SCRIPT_FUNCTIONS, bindings);
//				else if(script == scriptOngoing)
//					Util.getScriptEngine().eval(DBManager.getMissionOngoing(this.id) + SCRIPT_FUNCTIONS, bindings);
//				else if(script == scriptEnd)
//					Util.getScriptEngine().eval(DBManager.getMissionEnd(this.id) + SCRIPT_FUNCTIONS, bindings);
//			}
			if(script != null) script.eval(bindings);
			
			if(condition != null)condition.setDialog((String)bindings.get(VARIABLE_DIALOG));
			
			return (Boolean)bindings.get(MISSION_FLAG);
			
		} catch (ScriptException e) {
			log.error("exception", e);
		}		
		
		return false;
	}	
	
	private boolean check(Player player, Npc npc, PlayerMission mission, CompiledScript script){
		return check(player, npc, mission, script, false, null);
	}
	
	/**
	 * Execute the script
	 * 
	 * @param  @param player
	 * @param  @param script
	 * @param  @return    
	 * @return NpcDialogAction    
	 * @throws
	 */
	private DialogAction execute(Player player, Npc npc, PlayerMission mission, CompiledScript script, MissionCondition condition){
		Bindings bindings = Util.getScriptEngine().createBindings();
		bindings.put(VARIABLE_PLAYER, player);
		bindings.put(VARIABLE_NPC, npc);
		if(mission != null)bindings.put(VARIABLE_MISSION, mission);
		if(condition != null)bindings.put(MISSION_CONDITION, condition);
		bindings.put(VARIABLE_DIALOG, DEFAULT_DIALOG);
		bindings.put(VARIABLE_ACTION_IDS, new ArrayList<Double>());
		bindings.put(MISSION_CHECK, false);
		bindings.put(VARIABLE_UPGRADE, false);
		bindings.put(VARIABLE_QUESTION_ID, new Double(0));
		
		try {
//			if(Constants.DEBUG){
//				if(script == scriptStart)
//					Util.getScriptEngine().eval(DBManager.getMissionStart(this.id) + SCRIPT_FUNCTIONS, bindings);
//				else if(script == scriptOngoing)
//					Util.getScriptEngine().eval(DBManager.getMissionOngoing(this.id) + SCRIPT_FUNCTIONS, bindings);
//				else if(script == scriptEnd)
//					Util.getScriptEngine().eval(DBManager.getMissionEnd(this.id) + SCRIPT_FUNCTIONS, bindings);
//			}
			if(script != null) script.eval(bindings);
			
			String dialog = (String)bindings.get(VARIABLE_DIALOG);
			
			List<Double> actionIds = (List<Double>)bindings.get(VARIABLE_ACTION_IDS);
			List<Action> actions = new ArrayList<Action>(2);
			
			for(Double actionId : actionIds){
				actions.add(MissionMG.instance.getAction(actionId.intValue()));
			}
			
			Question question = null;
			
			int qid = ((Double)bindings.get(VARIABLE_QUESTION_ID)).intValue();
			if(qid > 0) question = MissionMG.instance.getQuestion(qid);
			
			// Commit
			DBService.commit(player);
			
			return new DialogAction(dialog, actions, question, (Boolean)bindings.get(VARIABLE_UPGRADE));
		} catch (ScriptException e) {
			log.error("exception", e);
		}
		
		return null;		
	}

	public long getTimer() {
		return timer;
	}

	public void setTimer(long timer) {
		this.timer = timer;
	}
	
	public void increaseTotalOngoing(){
		this.totalOngoing ++;
	}
	
	public void decreaseTotalOngoing(){
		this.totalOngoing --;
	}
	
	public void increateTotalOffer(){
		this.totalOffer ++;
	}

	public List<Mission> getPreMissions() {
		return preMissions;
	}

	public void setPreMissions(List<Mission> preMissions) {
		this.preMissions = preMissions;
	}
}
